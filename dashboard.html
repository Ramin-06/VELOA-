<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VELO AI | Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --navy: #0F172A; --gold: #D4AF37; --bg: #FAFAFA; --border: #F1F5F9; --text-light: #64748B; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); margin: 0; color: var(--navy); overflow-x: hidden; }
        
        .top-nav { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid var(--border); }
        .logo { font-weight: 700; font-size: 15px; letter-spacing: -0.5px; }
        .logo span { color: var(--gold); }
        .nav-tabs { display: flex; gap: 20px; position: absolute; left: 50%; transform: translateX(-50%); }
        .nav-link { cursor: pointer; font-size: 10px; font-weight: 600; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.8px; transition: 0.3s; }
        .nav-link.active { color: var(--navy); border-bottom: 1.5px solid var(--gold); padding-bottom: 2px; }
        
        .nav-right { display: flex; gap: 18px; align-items: center; }
        .notif-wrapper { position: relative; cursor: pointer; }
        .bell-icon { font-size: 16px; color: var(--text-light); }
        .notif-badge { position: absolute; top: -1px; right: -1px; width: 7px; height: 7px; background: #FF4D4D; border-radius: 50%; display: none; border: 1.5px solid white; }

        .container { max-width: 500px; margin: 0 auto; padding: 20px 15px; }
        
        .chat-container { height: calc(100vh - 150px); display: flex; flex-direction: column; }
        .chat-messages { flex: 1; overflow-y: auto; padding-bottom: 80px; display: flex; flex-direction: column; gap: 10px; }
        .bubble { max-width: 80%; padding: 10px 14px; border-radius: 14px; font-size: 13px; line-height: 1.5; animation: fadeIn 0.3s ease; }
        .bot { background: #FFFFFF; color: var(--navy); align-self: flex-start; border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        .user { background: var(--navy); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        
        .status-card { text-align: center; padding: 30px 0; }
        .status-card h3 { font-size: 16px; font-weight: 600; margin-bottom: 40px; }
        .progress-bar { display: flex; justify-content: space-between; position: relative; margin-bottom: 50px; padding: 0 10px; }
        .line-bg { position: absolute; top: 5px; left: 10px; right: 10px; height: 1.5px; background: #E2E8F0; z-index: 1; }
        .line-fill { position: absolute; top: 5px; left: 10px; height: 1.5px; background: var(--gold); z-index: 2; transition: 1s; width: 0%; }
        .dot { width: 10px; height: 10px; background: #E2E8F0; border-radius: 50%; z-index: 3; position: relative; }
        .dot.active { background: var(--gold); box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.15); }
        .dot.done { background: var(--gold); }
        .dot::after { content: attr(data-label); position: absolute; top: 18px; left: 50%; transform: translateX(-50%); font-size: 8px; color: var(--text-light); white-space: nowrap; }

        .archive-container { display: flex; flex-direction: column; gap: 12px; padding-top: 10px; }
        .archive-card { background: #FFFFFF; border: 1px solid var(--border); border-radius: 16px; padding: 15px; display: flex; align-items: center; gap: 15px; transition: 0.3s; position: relative; overflow: hidden; }
        .archive-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.05); border-color: var(--gold); }
        .archive-icon { width: 40px; height: 40px; background: #F8FAFC; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--gold); border: 1px solid var(--border); }
        .archive-details { flex: 1; }
        .archive-details b { font-size: 14px; color: var(--navy); display: block; margin-bottom: 2px; }
        .archive-details span { font-size: 11px; color: var(--text-light); display: flex; align-items: center; gap: 4px; }
        .archive-status { background: #ECFDF5; color: #10B981; font-size: 9px; font-weight: 700; padding: 4px 10px; border-radius: 20px; }

        .notif-dropdown { position: absolute; top: 40px; right: 0; width: 280px; background: #fff; border-radius: 14px; border: 1px solid var(--border); box-shadow: 0 15px 40px rgba(0,0,0,0.1); display: none; z-index: 1100; max-height: 400px; overflow-y: auto; }
        .notif-item { padding: 14px; border-bottom: 1px solid var(--border); position: relative; }
        .notif-text { font-size: 11.5px; line-height: 1.4; color: var(--navy); word-break: break-word; display: block; margin-bottom: 8px; }
        .notif-text a { color: #3B82F6; text-decoration: underline; font-weight: 500; }
        .notif-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; }
        .notif-time { font-size: 9px; color: var(--text-light); }
        .notif-tools { display: flex; gap: 12px; align-items: center; }
        .notif-tools i { cursor: pointer; transition: 0.2s; font-size: 13px; color: #CBD5E0; }

        .chat-input-area { position: fixed; bottom: 20px; left: 15px; right: 15px; max-width: 470px; margin: 0 auto; background: #fff; padding: 5px; border-radius: 100px; display: flex; align-items: center; border: 1px solid var(--border); box-shadow: 0 10px 25px rgba(0,0,0,0.04); }
        .chat-input-area input { flex: 1; border: none; padding: 10px 15px; font-size: 13px; background: transparent; }
        .send-btn { background: var(--navy); color: white; border: none; width: 34px; height: 34px; border-radius: 50%; cursor: pointer; }

        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<nav class="top-nav">
    <div class="logo">VELO<span>AI</span></div>
    <div class="nav-tabs">
        <div class="nav-link active" id="btn-active" onclick="switchTab('active')">Sifari≈ü</div>
        <div class="nav-link" id="btn-archive" onclick="switchTab('archive')">Arxiv</div>
    </div>
    <div class="nav-right">
        <div class="notif-wrapper" onclick="toggleNotifs(event)">
            <i class="fa-regular fa-bell bell-icon"></i>
            <div class="notif-badge" id="notif-badge"></div>
            <div class="notif-dropdown" id="notif-dropdown">
                <div id="notif-list"></div>
            </div>
        </div>
        <a href="cabinet.html" style="color:var(--text-light); font-size:14px;" onclick="localStorage.clear()"><i class="fa-solid fa-arrow-right-from-bracket"></i></a>
    </div>
</nav>

<div class="container">
    <div id="tab-active">
        <div id="chat-ui" class="chat-container hidden">
            <div class="chat-messages" id="chat-msgs"></div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Yazƒ±n..." onkeypress="if(event.key === 'Enter') handleUserMsg()">
                <button class="send-btn" onclick="handleUserMsg()"><i class="fa-solid fa-arrow-up"></i></button>
            </div>
        </div>
        <div id="status-ui" class="status-card hidden">
            <h3 id="st-shop-name">--</h3>
            <div class="progress-bar">
                <div class="line-bg"></div>
                <div class="line-fill" id="st-fill"></div>
                <div class="dot" id="d1" data-label="Q…ôbul"></div>
                <div class="dot" id="d2" data-label="Hazƒ±rlƒ±q"></div>
                <div class="dot" id="d3" data-label="Domain"></div>
                <div class="dot" id="d4" data-label="Qo≈üulma"></div>
                <div class="dot" id="d5" data-label="Hazƒ±r"></div>
            </div>
            <p id="st-label" style="font-size:12px; font-weight:600; margin-top:10px; color:var(--gold)"></p>
        </div>
    </div>
    <div id="tab-archive" class="hidden"><div id="archive-content"></div></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyA5eb16DAKSVLkEzYsUrgxL9vfrJP7w-es",
        authDomain: "etir-magazasi-d7679.firebaseapp.com",
        projectId: "etir-magazasi-d7679",
        storageBucket: "etir-magazasi-d7679.firebasestorage.app",
        messagingSenderId: "1045258773680",
        appId: "1:1045258773680:web:ab2edd54ba3f0ef0530775"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const activeUser = localStorage.getItem("activeUser");

    const botQs = ["Salam! üòä Maƒüazanƒ±n adƒ±nƒ± n…ô qoymaq ist…ôyirs…ôn?", "Maraqlƒ± addƒ±r! ‚ú® Hansƒ± paketi se√ßirs…ôn?", "N√∂mr…ôni yaza bil…ôrs…ôn?", "B…ôs e-po√ßt √ºnvanƒ±n?", "V…ô son olaraq, doƒüum tarixin? üéâ"];
    const dKeys = ["shopName", "packageName", "phone", "email", "birthDate"];
    let curQ = 0, collected = { userNickname: activeUser, status: 1 };
    let msgUnsub = null;

    function initApp() {
        if(!activeUser) { window.location.replace("cabinet.html"); return; }
        
        db.collection("orders").doc(activeUser).onSnapshot(doc => {
            if(doc.exists) {
                renderStatusUI(doc.data());
                listenToMessages("orders");
            } else {
                // Sƒ∞FARƒ∞≈û Bƒ∞TDƒ∞KD∆è (S∆èN∆èD Sƒ∞Lƒ∞NDƒ∞KD∆è) BURADA T∆èMƒ∞ZL∆èNƒ∞R
                document.getElementById('status-ui').classList.add('hidden');
                document.getElementById('chat-ui').classList.remove('hidden');
                
                // √áatbotun i√ßini t…ômizl…ô v…ô suallarƒ± sƒ±fƒ±rla
                const msgsDiv = document.getElementById('chat-msgs');
                msgsDiv.innerHTML = ""; 
                curQ = 0; 
                collected = { userNickname: activeUser, status: 1 };
                
                if(msgsDiv.children.length === 0) addBubble(botQs[0], 'bot');
                listenToMessages("completed_orders");
            }
        });
    }

    function renderStatusUI(data) {
        document.getElementById('chat-ui').classList.add('hidden');
        document.getElementById('status-ui').classList.remove('hidden');
        const s = data.status || 1;
        const lbls = ["Sifari≈ü q…ôbul edildi", "Hazƒ±rlƒ±q", "Domain", "ƒ∞nteqrasiya", "Hazƒ±r üéâ"];
        document.getElementById('st-shop-name').innerText = data.shopName;
        document.getElementById('st-label').innerText = lbls[s-1];
        document.getElementById('st-fill').style.width = ((s-1)/4*100) + "%";
        for(let i=1;i<=5;i++) document.getElementById('d'+i).className = 'dot '+(i<s?'done':(i===s?'active':''));
    }

    function listenToMessages(coll) {
        if(msgUnsub) msgUnsub();
        msgUnsub = db.collection(coll).doc(activeUser).collection("messages")
            .orderBy("time", "desc")
            .onSnapshot(snap => {
                const list = document.getElementById('notif-list'), badge = document.getElementById('notif-badge');
                const deleted = JSON.parse(localStorage.getItem("deletedNotifs") || "[]");
                let count = 0, html = "";

                snap.forEach(doc => {
                    const m = doc.data();
                    if(!deleted.includes(doc.id) && m.seen === false) {
                        count++;
                        const date = m.timeFormatted || "ƒ∞ndi";
                        const textWithLinks = m.text.replace(/(https?:\/\/[^\s]+)/g, url => `<a href="${url}" target="_blank">${url}</a>`);
                        html += `
                            <div class="notif-item">
                                <span class="notif-text">${textWithLinks}</span>
                                <div class="notif-meta">
                                    <span class="notif-time">${date}</span>
                                    <div class="notif-tools">
                                        <i class="fa-regular fa-copy" onclick="copyText('${m.text.replace(/'/g, "\\'")}')"></i>
                                        <i class="fa-solid fa-xmark" style="color:#FF4D4D; margin-left:10px;" onclick="removeNotif('${doc.id}', '${coll}', event)"></i>
                                    </div>
                                </div>
                            </div>`;
                    }
                });
                badge.style.display = count > 0 ? 'block' : 'none';
                list.innerHTML = count > 0 ? html : '<div style="padding:20px; color:#999; text-align:center; font-size:11px;">Bildiri≈ü yoxdur.</div>';
            });
    }

    async function removeNotif(id, coll, e) {
        if(e) e.stopPropagation();
        const deleted = JSON.parse(localStorage.getItem("deletedNotifs") || "[]");
        deleted.push(id);
        localStorage.setItem("deletedNotifs", JSON.stringify(deleted));
        try {
            await db.collection(coll).doc(activeUser).collection("messages").doc(id).update({ seen: true });
        } catch(err) { console.log("Update error"); }
    }

    function copyText(t) {
        navigator.clipboard.writeText(t).then(() => alert("Kopyalandƒ±!"));
    }

    async function handleUserMsg() {
        const inp = document.getElementById('chat-input'), v = inp.value.trim();
        if(!v) return;
        addBubble(v, 'user'); inp.value = "";
        collected[dKeys[curQ]] = v;
        curQ++;
        if(curQ < botQs.length) setTimeout(()=>addBubble(botQs[curQ], 'bot'), 600);
        else {
            collected.orderDate = new Date().toLocaleDateString('az-AZ');
            await db.collection("orders").doc(activeUser).set(collected);
        }
    }

    function addBubble(t, s) {
        const d = document.createElement('div'); d.className = `bubble ${s}`; d.innerText = t;
        const m = document.getElementById('chat-msgs'); m.appendChild(d); m.scrollTop = m.scrollHeight;
    }

    function toggleNotifs(e) { e.stopPropagation(); const d = document.getElementById('notif-dropdown'); d.style.display = d.style.display === 'block' ? 'none' : 'block'; }
    window.onclick = () => document.getElementById('notif-dropdown').style.display = 'none';

    function switchTab(t) {
        document.getElementById('btn-active').classList.toggle('active', t === 'active');
        document.getElementById('btn-archive').classList.toggle('active', t === 'archive');
        document.getElementById('tab-active').classList.toggle('hidden', t === 'archive');
        document.getElementById('tab-archive').classList.toggle('hidden', t === 'active');
        if(t === 'archive') loadArchive();
    }

    async function loadArchive() {
        const container = document.getElementById('archive-content');
        container.innerHTML = `<div style="text-align:center; padding:30px;"><i class="fa-solid fa-spinner fa-spin" style="color:var(--gold)"></i></div>`;
        try {
            const snapshot = await db.collection("completed_orders").where("userNickname", "==", activeUser).get();
            if (snapshot.empty) {
                container.innerHTML = `<p style="text-align:center; font-size:11px; color:#999; margin-top:40px;">Arxiv bo≈üdur.</p>`;
                return;
            }
            let html = '<div class="archive-container">';
            snapshot.forEach(doc => {
                const d = doc.data();
                html += `
                    <div class="archive-card">
                        <div class="archive-icon"><i class="fa-solid fa-box-archive"></i></div>
                        <div class="archive-details">
                            <b>${d.shopName || 'Maƒüaza'}</b>
                            <span><i class="fa-regular fa-calendar"></i> ${d.orderDate || ''}</span>
                        </div>
                        <div class="archive-status">Hazƒ±r</div>
                    </div>`;
            });
            container.innerHTML = html + '</div>';
        } catch(e) { container.innerHTML = "X…ôta!"; }
    }

    initApp();
</script>
</body>
</html>
