<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VELO AI | Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        if (localStorage.getItem("role") !== "admin") {
            window.location.replace("cabinet.html");
        }
    </script>

    <style>
        :root {
            --navy: #0F172A; --gold: #D4AF37; --bg: #FAFAFA; --white: #FFFFFF;
            --text-dark: #1E293B; --text-muted: #94A3B8; --success: #10B981; --border: #F1F5F9;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); margin: 0; color: var(--text-dark); }

        .sidebar { width: 220px; background: var(--navy); height: 100vh; color: white; padding: 25px; position: fixed; z-index: 100; border-right: 1px solid rgba(255,255,255,0.05); }
        .sidebar h2 { color: var(--gold); font-weight: 800; font-size: 16px; margin-bottom: 30px; letter-spacing: 1px; }
        .nav-item { padding: 10px 15px; margin-bottom: 6px; border-radius: 8px; cursor: pointer; transition: 0.2s; font-weight: 600; font-size: 13px; opacity: 0.5; }
        .nav-item.active { background: rgba(212, 175, 55, 0.1); color: var(--gold); opacity: 1; }

        .main { margin-left: 220px; padding: 30px 40px; min-height: 100vh; }
        .stats-row { display: flex; gap: 12px; margin-bottom: 25px; }
        .stat-pill { background: white; padding: 8px 16px; border-radius: 100px; border: 1px solid var(--border); display: flex; align-items: center; gap: 8px; }
        .stat-pill b { font-size: 14px; color: var(--navy); }
        .stat-pill span { font-size: 9px; text-transform: uppercase; font-weight: 800; color: var(--text-muted); }

        .search-wrapper { margin-bottom: 15px; position: relative; }
        .search-wrapper input { width: 100%; padding: 10px 15px 10px 35px; border-radius: 10px; border: 1px solid var(--border); font-size: 12px; font-family: inherit; }
        .search-wrapper i { position: absolute; left: 12px; top: 12px; color: var(--text-muted); font-size: 12px; }

        .table-card { background: white; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 10px rgba(0,0,0,0.02); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #FDFDFD; padding: 14px 20px; text-align: left; font-size: 10px; color: var(--text-muted); text-transform: uppercase; border-bottom: 1px solid var(--border); }
        td { padding: 12px 20px; border-bottom: 1px solid #FAFAFA; font-size: 13px; vertical-align: middle; }
        
        .last-msg-box { font-size: 11px; color: #64748B; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; background: #F8FAFC; padding: 4px 8px; border-radius: 4px; display: block; margin-top: 4px; }
        .seen { color: var(--success); font-weight: bold; margin-left: 5px; }
        .unseen { color: #CBD5E0; margin-left: 5px; }

        .u-detail { font-size: 10px; color: var(--text-muted); display: block; margin-top: 2px; }

        select { padding: 6px 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 12px; background: #F9FAFB; }
        .btn-mini { border: none; border-radius: 8px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
        .btn-save { background: var(--navy); color: white; padding: 7px 14px; font-weight: 700; font-size: 11px; }
        .btn-notif { background: white; color: var(--text-dark); width: 32px; height: 32px; font-size: 14px; border: 1px solid var(--border); transition: 0.2s; }
        .btn-history { background: #F1F5F9; color: var(--navy); padding: 5px 10px; font-size: 10px; font-weight: 700; margin-left: 5px; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal-content { background: white; margin: 10% auto; padding: 20px; width: 90%; max-width: 400px; border-radius: 15px; max-height: 75vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .history-item { padding: 12px; border-bottom: 1px solid #F8FAFC; display: flex; justify-content: space-between; align-items: center; }

        #orders-list-mobile, #customers-list-mobile, .mobile-nav { display: none; }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main { margin-left: 0; padding: 20px 15px 100px; }
            table { display: none; }
            #orders-list-mobile, #customers-list-mobile, .mobile-nav { display: flex; }
            #orders-list-mobile, #customers-list-mobile { flex-direction: column; }
            .mobile-card { background: white; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border); padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
            .m-info-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #F8FAFC; font-size: 11px; }
            .m-header-name { color: var(--gold); font-weight: 800; font-size: 15px; margin-bottom: 10px; display: block; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
            .m-footer { display: flex; gap: 8px; margin-top: 12px; padding-top: 10px; border-top: 1px solid #F1F5F9; align-items: center; }
            .mobile-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid var(--border); padding: 12px 0 25px; z-index: 1000; justify-content: space-around; }
            .m-tab { text-align: center; color: var(--text-muted); font-size: 9px; font-weight: 700; text-transform: uppercase; flex: 1; }
            .m-tab.active { color: var(--navy); }
            .m-tab i { display: block; font-size: 18px; margin-bottom: 4px; }
        }

        .section-pane { display: none; }
        .section-pane.active { display: block; }

/* Mesajların daşmaması üçün düzəliş */
.last-msg-box, .msg-text-cell { 
    word-break: break-all; 
    overflow-wrap: break-word; 
    max-width: 200px; 
}

/* Sidebar-da yeni bildiriş sayı nişanı */
.badge-count {
    background: #EF4444;
    color: white;
    font-size: 10px;
    padding: 2px 7px;
    border-radius: 20px;
    margin-left: 8px;
    font-weight: 800;
}

/* Oxunmamış müraciət satırı */
.unread-row { background-color: #FFFDF5 !important; }


/* Veb versiyada aşağıdakı artıq sətirləri (mobil kartları) tam gizlət */
#inbox-list-mobile {
    display: none !important;
}

/* Yalnız ekran kiçik olanda cədvəli gizlət, kartları göstər */
@media (max-width: 768px) {
    #inbox-list-desktop, 
    .table-card table { 
        display: none !important; 
    }
    #inbox-list-mobile { 
        display: flex !important; 
        flex-direction: column;
    }
}

/* Deaktiv düymə üçün xüsusi stil */
.btn-disabled {
    background: #94A3B8 !important;
    color: white !important;
    cursor: not-allowed !important;
    opacity: 0.7;
    border: none;
}
    </style>
</head>
<body>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="font-size:14px; margin:0; font-weight: 800;">Mesaj Tarixçəsi</h3>
                <i class="fa-solid fa-xmark" style="cursor:pointer; font-size: 18px;" onclick="closeHistory()"></i>
            </div>
            <div id="history-body"></div>
        </div>
    </div>

    <div class="sidebar">
        <h2>VELO AI</h2>
        <div class="nav-item active" id="d-nav-orders" onclick="showSection('orders')"><i class="fa-solid fa-list-check" style="margin-right:10px"></i> Sifarişlər</div>
        <div class="nav-item" id="d-nav-customers" onclick="showSection('customers')"><i class="fa-solid fa-users" style="margin-right:10px"></i> Müştərilər</div>
        <div class="nav-item" id="d-nav-inbox" onclick="showSection('inbox')">
    <i class="fa-solid fa-envelope-open-text" style="margin-right:10px"></i> Müraciətlər <span id="inbox-badge" class="badge-count" style="display:none">0</span>
</div>
    </div>

    <div class="main">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 style="font-size: 18px; font-weight: 800; margin:0;" id="page-title">Sifarişlər</h1>
            <button onclick="adminLogout()" style="background:#FFF1F1; color:#EF4444; border:none; padding:7px 14px; border-radius:8px; font-weight:700; cursor:pointer; font-size:10px;">ÇIXIŞ</button>
        </div>

        <div class="stats-row">
            <div class="stat-pill"><span>Cəmi</span><b id="count-total">0</b></div>
            <div class="stat-pill"><span>Aktiv</span><b id="count-active" style="color:var(--gold)">0</b></div>
            <div class="stat-pill"><span>Arxiv</span><b id="count-done" style="color:var(--success)">0</b></div>
        </div>

        <div id="orders-pane" class="section-pane active">
            <div class="table-card">
                <table>
                    <thead><tr><th>Müştəri / Məlumat</th><th>Mağaza / Paket</th><th>Status</th><th>Son Bildiriş</th><th>İdarə</th></tr></thead>
                    <tbody id="orders-list-desktop"></tbody>
                </table>
                <div id="orders-list-mobile"></div>
            </div>
        </div>

        <div id="customers-pane" class="section-pane">
    <div class="search-wrapper">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input type="text" id="custSearch" placeholder="İstifadəçi adına görə axtar..." onkeyup="filterCustomers()">
    </div>
    <div class="table-card">
        <table>
            <thead><tr><th>Müştəri Məlumatı</th><th>Mağaza</th><th>Tarix</th><th>İdarə</th></tr></thead>
            <tbody id="customers-list-desktop"></tbody>
        </table>
        <div id="customers-list-mobile"></div>
    </div>
</div>

        <div id="inbox-pane" class="section-pane">
    <div class="table-card">
        <table>
            <thead>
                <tr><th>Ticket / İstifadəçi</th><th>Mesaj</th><th>Əlaqə</th><th>Tarix</th><th>İdarə</th></tr>
            </thead>
            <tbody id="inbox-list-desktop"></tbody>
        </table>
        <div id="inbox-list-mobile"></div>
    </div>
</div>
    </div>

    <div class="mobile-nav">
        <div class="m-tab active" id="m-tab-orders" onclick="showSection('orders')"><i class="fa-solid fa-list"></i>Sifariş</div>
        <div class="m-tab" id="m-tab-customers" onclick="showSection('customers')"><i class="fa-solid fa-user-group"></i>Müştəri</div>
        <div class="m-tab" id="m-tab-inbox" onclick="showSection('inbox')"><i class="fa-solid fa-inbox"></i>Inbox</div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA5eb16DAKSVLkEzYsUrgxL9vfrJP7w-es",
            authDomain: "etir-magazasi-d7679.firebaseapp.com",
            projectId: "etir-magazasi-d7679",
            storageBucket: "etir-magazasi-d7679.firebasestorage.app",
            messagingSenderId: "1045258773680",
            appId: "1:1045258773680:web:ab2edd54ba3f0ef0530775"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let archiveData = [];

        function getStatusMarkup(d) {
    if(!d.lastNotification) return '<span style="color:#CCC; font-size:10px;">Yoxdur</span>';
    
    // notifSeen false olanda tək tik, true olanda cüt yaşıl tik
    const tick = d.notifSeen ? 
        '<i class="fa-solid fa-check-double seen"></i>' : 
        '<i class="fa-solid fa-check unseen"></i>';
        
    return `<div style="display:flex; align-items:center;">
                <div class="last-msg-box">${d.lastNotification}</div>
                ${tick}
            </div>`;
}

        function initAdmin() {
            db.collection("orders").onSnapshot(snap => {
                const dList = document.getElementById("orders-list-desktop");
                const mList = document.getElementById("orders-list-mobile");
                
                dList.innerHTML = ""; mList.innerHTML = "";
                document.getElementById('count-active').innerText = snap.size;
                updateTotal();
                
                snap.forEach(doc => {
                    const d = doc.data(); const id = doc.id;
                    const stMarkup = getStatusMarkup(d);
                    const options = `<option value="1" ${d.status==1?'selected':''}>Qəbul</option><option value="2" ${d.status==2?'selected':''}>Hazırlıq</option><option value="3" ${d.status==3?'selected':''}>Domain</option><option value="4" ${d.status==4?'selected':''}>Sistem</option><option value="5" ${d.status==5?'selected':''}>Bitir</option>`;
                   
                    dList.innerHTML += `<tr><td><b style="color:var(--gold)">@${d.userNickname}</b><span class="u-detail"><i class="fa-solid fa-phone"></i> ${d.phone || 'Yoxdur'}</span><span class="u-detail"><i class="fa-solid fa-envelope"></i> ${d.email || 'Yoxdur'}</span><span class="u-detail"><i class="fa-solid fa-cake-candles"></i> ${d.birthDate || 'Yoxdur'}</span></td><td><b>${d.shopName}</b><br><small>${d.packageType || 'Standart'}</small></td><td><select id="status-d-${id}">${options}</select></td><td>${stMarkup}</td><td style="display:flex; gap:8px"><button class="btn-mini btn-save" onclick="updateStatus('${id}', 'd')">OK</button><button class="btn-mini btn-history" style="background:#fff; border:1px solid var(--border)" onclick="viewHistory('${id}', 'orders')"><i class="fa-solid fa-clock-rotate-left"></i></button><button class="btn-mini btn-notif" onclick="sendMsg('${id}', 'orders')"><i class="fa-regular fa-bell"></i></button></td></tr>`;
                    mList.innerHTML += `<div class="mobile-card"><span class="m-header-name">@${d.userNickname}</span><div class="m-info-row"><span>Mağaza:</span> <span>${d.shopName}</span></div><div class="m-info-row"><span>Gmail:</span> <span>${d.email || '---'}</span></div><div class="m-info-row"><span>Doğum T.:</span> <span>${d.birthDate || '---'}</span></div><div style="margin:10px 0;">${stMarkup}</div><div class="m-footer"><select id="status-m-${id}" style="flex:1">${options}</select><button class="btn-mini btn-save" onclick="updateStatus('${id}', 'm')">OK</button><button class="btn-mini btn-notif" onclick="sendMsg('${id}', 'orders')"><i class="fa-regular fa-bell"></i></button></div></div>`;
                });
            });

            db.collection("completed_orders").onSnapshot(snap => {
                archiveData = [];
                snap.forEach(doc => archiveData.push({id: doc.id, ...doc.data()}));
                renderArchive(archiveData);
                document.getElementById('count-done').innerText = snap.size;
                updateTotal();
            });
        }

        function renderArchive(data) {
            const dList = document.getElementById("customers-list-desktop");
            const mList = document.getElementById("customers-list-mobile");
            dList.innerHTML = ""; mList.innerHTML = "";
            data.forEach(d => {
                dList.innerHTML += `<tr><td><b>@${d.userNickname}</b><span class="u-detail">${d.phone || ''} | ${d.email || ''} | ${d.birthDate || ''}</span></td><td><b>${d.shopName}</b></td><td>${d.orderDate || '---'}</td><td style="display:flex; gap:8px"><button class="btn-mini btn-history" onclick="viewHistory('${d.id}', 'completed_orders')">MESAJLAR</button><button class="btn-mini btn-notif" onclick="sendMsg('${d.id}', 'completed_orders')"><i class="fa-regular fa-bell"></i></button></td></tr>`;
                mList.innerHTML += `<div class="mobile-card" style="border-left: 4px solid var(--success);"><span class="m-header-name" style="color:var(--success)">@${d.userNickname}</span><div class="m-info-row"><span>Mağaza:</span> <span>${d.shopName}</span></div><div class="m-footer"><button class="btn-mini btn-history" onclick="viewHistory('${d.id}', 'completed_orders')" style="flex:1">TARİXÇƏ</button><button class="btn-mini btn-notif" onclick="sendMsg('${d.id}', 'completed_orders')"><i class="fa-regular fa-bell"></i></button></div></div>`;
            });
        }

        function filterCustomers() {
            const q = document.getElementById("custSearch").value.toLowerCase();
            const filtered = archiveData.filter(item => item.userNickname.toLowerCase().includes(q));
            renderArchive(filtered);
        }

        async function sendMsg(id, coll) {
    const docRef = await db.collection(coll).doc(id).get();
    if (!docRef.exists) return alert("Müştəri tapılmadı!");
    
    const username = docRef.data().userNickname;
    const msg = prompt(`@${username} üçün bildiriş yazın:`);
    
    if (msg) {
        const success = await universalSender(username, msg);
        if (success) alert("Bildiriş müştəriyə çatdırıldı!");
    }
}

        async function viewHistory(id, coll) {
            const body = document.getElementById("history-body");
            body.innerHTML = "Yüklənir...";
            document.getElementById("historyModal").style.display = "block";
            const snap = await db.collection(coll).doc(id).collection("messages").orderBy("time", "desc").get();
            body.innerHTML = snap.empty ? "Mesaj yoxdur." : "";
            snap.forEach(doc => {
                const m = doc.data();
                const side = m.sender === 'admin' ? 'color:var(--navy); font-weight:bold;' : 'color:var(--gold);';
                const tick = m.seen ? '<i class="fa-solid fa-check-double" style="color:#10B981"></i>' : '<i class="fa-solid fa-check" style="color:#CBD5E0"></i>';
                body.innerHTML += `<div class="history-item"><div style="flex:1"><span style="${side}">${m.sender === 'admin' ? 'Siz: ' : 'Müştəri: '}</span>${m.text}<br><small style="font-size:9px; color:#94A3B8">${m.timeFormatted || ''}</small></div><div>${tick}</div></div>`;
            });
        }

        function closeHistory() { document.getElementById("historyModal").style.display = "none"; }

        async function updateStatus(id, type) {
            const selectEl = document.getElementById(`status-${type}-${id}`);
            const v = parseInt(selectEl.value);
            if(v === 5) {
                if(!confirm("Sifarişi arxivləmək istəyirsiniz?")) return;
                const ref = await db.collection("orders").doc(id).get();
                await db.collection("completed_orders").doc(id).set({...ref.data(), status: 5});
                const msgs = await db.collection("orders").doc(id).collection("messages").get();
                for (const m of msgs.docs) await db.collection("completed_orders").doc(id).collection("messages").doc(m.id).set(m.data());
                await db.collection("orders").doc(id).delete();
            } else { await db.collection("orders").doc(id).update({status: v}); }
        }

        function showSection(sect) {
    // 1. Bütün panelləri gizlə
    document.querySelectorAll('.section-pane').forEach(p => p.classList.remove('active'));
    
    // 2. Bütün menyu düymələrindən (Veb və Mobil) aktivlik rəngini sil
    document.querySelectorAll('.nav-item, .m-tab').forEach(i => i.classList.remove('active'));
    
    // 3. Seçilən paneli göstər
    const targetPane = document.getElementById(sect + '-pane');
    if (targetPane) {
        targetPane.classList.add('active');
    }

    // 4. Veb menyuda rəngi aktiv et
    const desktopNav = document.getElementById('d-nav-' + sect);
    if (desktopNav) {
        desktopNav.classList.add('active');
    }

    // 5. Mobil menyuda rəngi aktiv et
    const mobileNav = document.getElementById('m-tab-' + sect);
    if (mobileNav) {
        mobileNav.classList.add('active');
    }
    
    // 6. Yuxarıdakı başlığı dəyiş
    const titles = { 
        orders: 'Sifarişlər', 
        customers: 'Müştərilər', 
        inbox: 'Müraciətlər' 
    };
    document.getElementById('page-title').innerText = titles[sect] || 'Panel';
}

        function updateTotal() {
            const a = parseInt(document.getElementById('count-active').innerText) || 0;
            const d = parseInt(document.getElementById('count-done').innerText) || 0;
            document.getElementById('count-total').innerText = a + d;
        }

        function adminLogout() { localStorage.clear(); window.location.replace("cabinet.html"); }
        
        // 1. Inbox Məlumatlarını Real-vaxtda Dinləmək
function initInbox() {
    db.collection("inbox").orderBy("time", "desc").onSnapshot(snap => {
        const dList = document.getElementById("inbox-list-desktop");
        const mList = document.getElementById("inbox-list-mobile");
        const badge = document.getElementById("inbox-badge");
        let unreadCount = 0;
        
        dList.innerHTML = ""; 
        mList.innerHTML = "";
        
        snap.forEach(doc => {
            const d = doc.data(); 
            const id = doc.id;
            
            if(d.status === "unread") unreadCount++;
            
            // Status yoxlanışı: Cavablanıbsa deaktiv et
            const isReplied = (d.status === "replied");
            const btnText = isReplied ? "CAVABLANDI" : "CAVABLA";
            const btnClass = isReplied ? "btn-mini btn-disabled" : "btn-mini btn-save";
            const btnAttr = isReplied ? "disabled" : "";

            // Desktop sətiri (Veb üçün)
            dList.innerHTML += `
                <tr class="${d.status === 'unread' ? 'unread-row' : ''}" style="${isReplied ? 'opacity: 0.8;' : ''}">
                    <td><b style="color:var(--gold)">#${d.ticketID}</b><br><small>@${d.username}</small></td>
                    <td class="msg-text-cell">${d.message}</td>
                    <td><small>${d.phone}<br>${d.email || ''}</small></td>
                    <td><small>${d.date || '---'}</small></td>
                    <td>
                        <button class="${btnClass}" 
                                onclick="replyInbox('${id}', '${d.username}', '${d.ticketID}')" 
                                ${btnAttr}>
                            ${btnText}
                        </button>
                    </td>
                </tr>`;

            // Mobil kartı (Yalnız mobildə görünəcək)
            mList.innerHTML += `
                <div class="mobile-card">
                    <span class="m-header-name">#${d.ticketID} - @${d.username}</span>
                    <div style="font-size:12px; margin:8px 0; word-break:break-word;">${d.message}</div>
                    <div class="m-info-row"><span>Tel:</span> <span>${d.phone}</span></div>
                    <div class="m-footer">
                        <button class="${btnClass}" style="width:100%"
                                onclick="replyInbox('${id}', '${d.username}', '${d.ticketID}')" 
                                ${btnAttr}>
                            ${btnText}
                        </button>
                    </div>
                </div>`;
        });

        if(badge) {
            badge.style.display = unreadCount > 0 ? "inline-block" : "none";
            badge.innerText = unreadCount;
        }
    });
}

// 2. Müraciətə Cavab Vermə (İstifadəçinin Dashboard-una gedir)
async function universalSender(username, messageText, ticketID = null) {
    if (!messageText || messageText.trim() === "") return;
    try {
        const now = Date.now();
        const timeStr = new Date().toLocaleString('az-AZ');
        const fullMsg = ticketID ? `Ticket #${ticketID} cavabı: ${messageText}` : messageText;

        const msgData = {
            text: fullMsg,
            time: now,
            sender: 'admin',
            timeFormatted: timeStr,
            seen: false 
        };

        // 1. MÜŞTƏRİ PANELİ ÜÇÜN (Dashboard-da görünməsi üçün)
        const userRef = db.collection("users").doc(username);
        await userRef.collection("messages").add(msgData);
        await userRef.set({ hasNotif: true, lastUpdate: now }, { merge: true });

        // 2. ADMIN TARİXÇƏSİ ÜÇÜN (viewHistory funksiyasında görünməsi üçün)
        const ordersRef = db.collection("orders");
        const archiveRef = db.collection("completed_orders");
        
        // Həm aktiv sifarişlərdə, həm arxivdə axtarırıq
        const orderQuery = await ordersRef.where("userNickname", "==", username).get();
        const archiveQuery = await archiveRef.where("userNickname", "==", username).get();

        // Aktiv sifariş varsa oraya yaz
        if (!orderQuery.empty) {
            const docId = orderQuery.docs[0].id;
            await ordersRef.doc(docId).collection("messages").add(msgData);
            await ordersRef.doc(docId).update({
                lastNotification: messageText,
                notifSeen: false,
                lastUpdate: now
            });
        } 
        
        // Arxivdə varsa oraya da yaz (Müştəri yerindən göndəriləndə bura düşəcək)
        if (!archiveQuery.empty) {
            const docId = archiveQuery.docs[0].id;
            await archiveRef.doc(docId).collection("messages").add(msgData);
        }

        return true;
    } catch (e) {
        console.error("Göndərmə xətası:", e);
        return false;
    }
}

async function replyInbox(docId, username, tID) {
    const replyText = prompt(`Ticket #${tID} üçün cavabınız:`);
    if (replyText) {
        const success = await universalSender(username, replyText, tID);
        if (success) {
            // Bu hissə Inbox bölməsindəki müraciəti arxivləyir (replied statusu verir)
            await db.collection("inbox").doc(docId).update({ status: "replied" });
            alert("Müraciət cavablandırıldı!");
        }
    }
}

// Əsas Naviqasiya Funksiyası (Veb və Mobil üçün vahid rəng və başlıq idarəsi)
function showSection(sect) {
    // 1. Panelləri idarə et
    document.querySelectorAll('.section-pane').forEach(p => p.classList.remove('active'));
    const targetPane = document.getElementById(sect + '-pane');
    if (targetPane) targetPane.classList.add('active');

    // 2. Menyu düymələrinin rəngini (active klassını) idarə et
    document.querySelectorAll('.nav-item, .m-tab').forEach(i => i.classList.remove('active'));
    
    // Veb rəngi
    const dNav = document.getElementById('d-nav-' + sect);
    if (dNav) dNav.classList.add('active');
    
    // Mobil rəngi
    const mNav = document.getElementById('m-tab-' + sect);
    if (mNav) mNav.classList.add('active');

    // 3. Başlığı dəyiş
    const titles = { 
        orders: 'Sifarişlər', 
        customers: 'Müştərilər', 
        inbox: 'Müraciətlər' 
    };
    document.getElementById('page-title').innerText = titles[sect] || 'Panel';
}

// Bütün sistemləri başlat
initAdmin();
initInbox(); // <-- Bu mütləq olmalıdır ki, müraciətlər yüklənsin
    </script>
</body>
</html>
